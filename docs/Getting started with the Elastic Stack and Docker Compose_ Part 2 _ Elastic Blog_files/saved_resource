if(window.userledSettings)window.userledSettings.enableDynamicAssets=true;if(window.userledSettings)window.userledSettings.version='7a09d5984d523088cd853ae7627c86ca50a3e66a';var vn=Object.defineProperty;var wn=(e,t,n)=>t in e?vn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var d=(e,t,n)=>(wn(e,typeof t!="symbol"?t+"":t,n),n);import{g as mt,s as ht,r as bn,l as a,a as pt,D as ce,b as En,H as J,A as y,u as Y,c as le,d as In,C as v,V as gt,e as ft,S as Pe,f as Sn,t as S,h as de,R as ze,i as An,I as je,j as Cn,k as Tn,_ as Pn,p as yt,m as xn,n as b,P as On,o as C,q as vt,v as Ln,w as oe,x as _n,y as Be,W as kn,z as Fn,B as Hn,E as Mn,F as $n,G as Dn,J as Un,K as wt,L as Rn,M as Nn,N as Kn,O as qn,Q as Vn,T as zn,U as jn,X as Bn,Y as Wn,Z as bt,$ as Gn,a0 as Jn,a1 as Et,a2 as Yn}from"./assets/_commonjsHelpers-17abe15a.js";const It=e=>{const t=mt(e);if(!t)return null;try{return JSON.parse(t)}catch{return null}},St=(e,t)=>{t?ht(e,JSON.stringify(t)):bn(e)},At=()=>`userled_matched_inbound_campaign_${window.location.href}`,Qn=e=>{St(At(),e)},Zn=()=>It(At()),Ct="userled_inbound_campaigns",Xn=e=>{St(Ct,e)},er=()=>It(Ct),Tt=e=>({...e,getValue:t=>e.vars[t.raw]}),tr=async e=>{const t=await fetch(e.serverUrl+"/api/inbound-campaigns/match",{method:"POST",body:JSON.stringify(e)});if(!t.ok){const r=await t.text();throw new Error(`Failed to match inbound campaign - status=${t.status} error=${r}`)}const n=await t.json();return n?Tt(n):null},We=async e=>{try{const t=await tr(e);return Qn(t),t}catch(t){throw new Error(`Failed to match inbound campaign: ${t}`)}},nr=async e=>{const t=Zn();return t?(We(e),Tt(t)):We(e)};class xe{static enqueue(t){return new Promise((n,r)=>{this.queue.push({promise:t,resolve:n,reject:r}),this.dequeue()})}static async dequeue(){if(this.workingOnPromise)return;const t=this.queue.shift();if(t){this.workingOnPromise=!0;try{const n=await t.promise();t.resolve(n)}catch(n){t.reject(n)}this.workingOnPromise=!1,this.dequeue()}}}xe.queue=[];xe.workingOnPromise=!1;const we=(e,t)=>{const n=sr[e==null?void 0:e.Operation];if(!n)return console.error(`invalid operation [${e==null?void 0:e.Operation}]`),!1;const r=n(e.Value,t);return a(`Condition ${r}: [${e.Operation} - ${e.Value}] against value ${t}`),r},ue=(e,t)=>{const n=i=>{let o=i==null?void 0:i.replace(new RegExp("(^(http(s)?:\\/\\/)?(www\\.)?)|((\\/)?(\\?.*)?$)","gi"),"");return o=o.replace(/^(localhost|127.0.0.1|[::1])(:d+)?/,"localhost"),o},r=n(e),s=n(t);return r===s},rr=(e,t)=>t.includes(e),sr={"matches url":ue,contains:rr};let Oe=()=>{};function Pt(e){Oe({...e.data})}function ir(e){Oe=e,window.addEventListener("message",Pt,!1)}function or(){Oe=()=>{},window.removeEventListener("message",Pt,!1)}function ar(e){if(!e||!cr(e))return 0;const t=Number(e.slice(0,e.length-1))||0,n=e.slice(e.length-1),r=lr[n]??0;return t*r}function cr(e){return e?new RegExp("^[0-9]+[smhdw]$").test(e):!1}const lr={s:1e3,m:6e4},dr=e=>{const t=["co.uk",".co.jp",".co.kr",".co.nf",".co.nz"],n=e.split(".");if(n.length===1||/^[0-9.]+$/.test(e))return e;for(let r=0;r<t.length;r++){const s=t[r];if(s&&e.endsWith(s)){const i=s.split(".");return n.slice(-(i.length+1)).join(".")}}return n.slice(-2).join(".")};let X;const ur=new Uint8Array(16);function mr(){if(!X&&(X=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!X))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return X(ur)}const m=[];for(let e=0;e<256;++e)m.push((e+256).toString(16).slice(1));function hr(e,t=0){return m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]}const pr=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ge={randomUUID:pr};function gr(e,t,n){if(Ge.randomUUID&&!t&&!e)return Ge.randomUUID();e=e||{};const r=e.random||(e.rng||mr)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){n=n||0;for(let s=0;s<16;++s)t[n+s]=r[s];return t}return hr(r)}const xt="userled_session_id",fr=1/288,yr=()=>{const e=Ot()??gr();return vr(e),e},Ot=()=>pt.get(xt),vr=e=>{const t=dr(window.location.hostname);pt.set(xt,e,{domain:`.${t}`,sameSite:"lax",expires:fr})},P=(e,t)=>{if(!ce())return En(e,t),fetch(`${J}/api/sdk/events`,{method:"POST",headers:{"Userled-Org-Id":y()},body:JSON.stringify({id:Y(),userId:le(),requestId:In(),sessionId:yr(),orgId:y(),name:e,body:t,happenedAt:new Date().toISOString(),userAgent:navigator.userAgent,channel:t.channel||v.None,version:gt()})})},wr="2147483647";let l;const ae=new Map;let be=!1,z=!1;async function br(e){a(e.promptId);const t=e.promptId,n=e.triggers;if(ae.set(t,n),l){a("already showing prompt");return}const r=de();if(we(n.urlCondition,r)){Lt(t);return}}const Er=()=>{z=!1;const e=de(),t=ae.get((l==null?void 0:l.id)||"");if(t&&!we(t.urlCondition,e)&&kt(),!l){for(const[n,r]of ae)if(we(r.urlCondition,e)){Lt(n);break}}};function Lt(e){a(`Displaying prompt with id ${e}`);const t=ft(),n=Pe().app_id,r=document.createElement("iframe");r.id="userledPrompt",r.src=Sn+"/src/index.html",r.style.position="fixed",r.style.border="none",r.style.zIndex=wr,r.name=`${e},${n},${t}`,r.setAttribute("allowtransparency","true"),r.allowFullscreen=!0,r.style.opacity="0",r.style.bottom=S(0),r.style.right=S(0),ir(Ir),l={id:e,iframe:r,size:{width:0,height:0},position:{}},document.body.appendChild(r)}function Ir(e){if(l)switch(e.type){case ze.Resize:return Sr(e);case ze.Interacted:return Pr(e)}}async function Sr(e){if(l){if(!z){const t=ar(e.payload.options.delay);await An(t)}a(`Resizing prompt ${e.payload.width} ${e.payload.height}`),l.size={width:e.payload.width,height:e.payload.height},a("Positioning prompt",e.payload.options.position),l.position=e.payload.options.position,_t()}}function _t(){if(!l||!l.size.height||!l.size.width)return;const e=xr(l.size);Ar(e),be=e,be&&!z&&(z=!0,Tr(l.id))}function Ar(e=!0){if(a(`Setting prompt visibility to ${e}`),!l)return;const t=l.iframe,n=l.position,r=l.size,s=n.left===0&&n.right===0,i=n.top===0&&n.bottom===0;t.style.width=s?"100%":S(r.width),t.style.height=i?"100%":S(r.height),t.style.top=S(n.top),t.style.right=S(n.right),t.style.bottom=S(n.bottom),t.style.left=S(n.left),t.style.display=e?"block":"none",t.style.opacity=e?"1":"0"}function kt(){or(),l&&(a(`Dismissing promptId [${l.id}]`),l.iframe.remove(),l=void 0,be=!1)}function Cr(e,t){a(`Sending prompt interaction [${t}] for promptId: [${e}]`),P("PROMPT_INTERACTION",{promptId:e,interactionId:t})}function Tr(e){a(`Sending prompt rendered for promptId: [${e}]`),P("PROMPT_RENDERED",{promptId:e})}function Pr(e){if(!l){console.error("Interaction on non-existing prompt");return}const t={...l};switch(ae.delete(l.id),z=!1,kt(),Cr(t.id,e.id),e.interactionType){case je.Dismissal:break;case je.Redirect:{const{redirectLink:n,useNewTab:r}=e.payload;n&&Cn(n,r);break}}}function xr(e){const t=Math.min(window.innerWidth,window.screen.width),n=Math.min(window.innerHeight,window.screen.height),r=e.width??0,s=e.height??0;return r<=t&&s<=n}const Or=()=>l,Lr=["display","width","height","objectFit","objectPosition"],Le=["div","li"],_e=["h1","h2","h3","h4","h5","p","button",...Le],Ft=e=>Array.from(e.childNodes).every(t=>t.nodeName==="#text"||t.nodeName==="SPAN"&&Ft(t)||t.nodeName==="P"&&t.hasAttribute(j)||t.nodeName==="BR"),ke=["img"],_r=["picture"],kr=["source"],Fe=["a"],Ht=["input"],Mt=["iframe"],Fr=["svg"],Hr=["head","script"],Mr=[..._e,...ke,...Fe,...Le,...Ht,...Mt,...Fr],_=e=>_e.includes(e.tagName.toLowerCase()),k=e=>ke.includes(e.tagName.toLowerCase()),$t=e=>_r.includes(e.tagName.toLowerCase()),Dt=e=>kr.includes(e.tagName.toLowerCase()),F=e=>Fe.includes(e.tagName.toLowerCase()),U=e=>Ht.includes(e.tagName.toLowerCase()),Ut=e=>e.tagName.toLowerCase()==="head",Rt=e=>e.tagName.toLowerCase()==="script",R=e=>Mt.includes(e.tagName.toLowerCase()),N=e=>e instanceof SVGElement,Je=e=>e.hasAttribute("data-hs-forms-root"),Ye=e=>e.hasAttribute(qr),$r=e=>_e.includes(e.tag),Dr=e=>ke.includes(e.tag),Ur=e=>Fe.includes(e.tag),Qe=e=>Hr.includes(e.tag),Ze=e=>{const t=e.textContent;if(!t)return null;const n=t.match(/hbspt.forms.create(([^)]+))/);return!n||!n[1]?null:JSON.parse(n[1].trim().replace(/(w+):/g,'"$1":'))},Xe=e=>{const t=e.cloneNode(!0);return t.removeAttribute("xmlns"),t.removeAttribute(j),t.removeAttribute(x),t.removeAttribute(T),new XMLSerializer().serializeToString(e)};function Rr(e){for(var t=-1,n=e==null?0:e.length,r=0,s=[];++t<n;){var i=e[t];i&&(s[r++]=i)}return s}var Nr=Rr;const Kr=Tn(Nr);let Ee;Pn(()=>import("./assets/finder-c29405a7.js"),[]).then(e=>Ee=e.finder);const se=new Map,x="data-userled-id",T="parent-userled-id",j="data-userled-noselect",Nt=".hbspt-form",qr="data-hubspot-rendered",Vr=e=>`[${T}='${e}']`,me=e=>`[${x}='${e}']`,V=class V{constructor(t,n,r){d(this,"id");d(this,"element");d(this,"style");d(this,"serialise",()=>{const n=new XMLSerializer().serializeToString(this.element);return{id:this.id,element:n,style:this.style}});d(this,"tag",()=>this.element.tagName.toLowerCase());d(this,"userledTag",()=>this.element.getAttribute(x)||void 0);d(this,"isAllowed",()=>this.element.hasAttribute(j)?!1:Je(this.element)?!0:Le.includes(this.element.tagName.toLowerCase())?Ft(this.element):Mr.includes(this.tag()));d(this,"isSelectable",()=>!this.element.hasAttribute(j));d(this,"isText",()=>_(this.element));d(this,"isImage",()=>k(this.element));d(this,"isButton",()=>F(this.element));d(this,"isInput",()=>U(this.element));d(this,"isIFrame",()=>R(this.element));d(this,"isSvg",()=>N(this.element));d(this,"isHubspotForm",()=>Je(this.element));d(this,"value",()=>{if(Ye(this.element)){const t=Ze(this.element);if(!t){console.error("Failed to parse Hubspot script data");return}return t}if(N(this.element))return{value:Xe(this.element)};if(k(this.element))return{url:this.element.src};if(F(this.element))return{value:this.element.innerHTML,href:this.element.getAttribute("href")||""};if(U(this.element))return{value:this.element.value,placeholder:this.element.placeholder};if(R(this.element))return{src:this.element.src};if(Rt(this.element))return{value:this.element.innerHTML};if(_(this.element))return{value:this.element.innerHTML};if(Ut(this.element))return{value:""};console.error("Element is not allowed",this.tag())});d(this,"getStyle",()=>{const t=window.getComputedStyle(this.element),n={};for(const r of Lr){const s=t.getPropertyValue(r);s&&(n[r]=s)}return n});d(this,"assetProp",()=>{if(k(this.element))return{type:"image",label:"Image",propKey:this.id||"",tag:this.tag(),userledId:this.userledTag(),src:this.element.srcset||this.element.src,imageType:"custom_url"};if(F(this.element)){const t={type:"button",label:"Button",propKey:this.id||"",tag:this.tag(),userledId:this.userledTag(),value:this.findAllowedChildren().length>0?void 0:this.element.innerHTML,href:this.element.getAttribute("href")||""},n=this.findAllowedChildren();return n.length>0&&(t.children=Kr(n.map(r=>r.assetProp())).map(r=>({...r,parentKey:t.propKey}))),t}if(R(this.element))return{type:"iframe",label:"IFrame Embed",propKey:this.id||"",tag:this.tag(),userledId:this.userledTag(),src:this.element.src};if(N(this.element))return{type:"svg",label:"SVG",propKey:this.id||"",tag:this.tag(),userledId:this.userledTag(),value:Xe(this.element)};if(U(this.element))return{type:"input",label:"Input",propKey:this.id||"",tag:this.tag(),userledId:this.userledTag(),value:this.element.value,placeholder:this.element.placeholder};if(Ye(this.element)){const t=Ze(this.element);return t||console.error("Failed to parse Hubspot script data"),{type:"contactForm",label:"Hubspot Form",propKey:this.id||"",tag:this.tag(),userledId:this.userledTag(),region:(t==null?void 0:t.region)||"",portalId:(t==null?void 0:t.portalId)||"",formId:(t==null?void 0:t.formId)||""}}if(_(this.element))return{type:"text",label:"Text",propKey:this.id||"",tag:this.tag(),userledId:this.userledTag(),value:this.element.innerHTML};console.error("Element is not allowed",this.tag())});d(this,"selector",t=>{if(!t||!Ee)return this.id;const n=Ee(t,{root:this.element,seedMinLength:1,optimizedMinLength:2});return n?[this.id,n].join(" "):(console.error("Child not found for element",t),this.id)});d(this,"findAllowedChildren",(t=this,n=5)=>{const r=[];if(n===0)return t.isAllowed()?[t]:[];t.id!==this.id&&t.isAllowed()&&r.push(t);for(const s of t.element.children)(s instanceof HTMLElement||s instanceof SVGElement)&&r.push(...this.findAllowedChildren(new V(s,void 0,this.selector(s)),n-1));return r});this.element=t,this.style=n??this.getStyle(),this.id=r}};d(V,"Deserialise",t=>{const r=new DOMParser().parseFromString(t.element,"text/html"),s=r.body.firstChild||r.head.firstChild;return new V(s,t.style,t.id)});let B=V;const Kt=e=>{e.dataset.originalDisplay=e.style.display,e.style.setProperty("display","none","important")},zr=(e,t)=>{var n;e.dataset.userledHubspotFormScriptHandled="true",(n=e.parentElement)==null||n.querySelectorAll(Nt).forEach(r=>{r instanceof HTMLElement&&(r.style.setProperty("display","none","important"),r.dataset.userledHubspotFormId=t)})},qt=e=>{e.style.display=e.dataset.originalDisplay||"",e.removeAttribute("data-original-display")},jr=(e,t,{trigger:n}={})=>{const r=document.createElement("script");if(n){const s=document.createTextNode(`hbspt.forms.create(${JSON.stringify({region:t.region,portalId:t.portalId,formId:t.formId})});`);return r.appendChild(s),e.insertAdjacentElement("afterend",r),r}return e.insertAdjacentHTML("afterend",`<script>        hbspt.forms.create(${JSON.stringify({region:t.region,portalId:t.portalId,formId:t.formId})});      </script>`),e.nextElementSibling},Br=(e,t)=>{var n,r;(r=(n=e.parentElement)==null?void 0:n.querySelectorAll(Nt))==null||r.forEach(s=>{s instanceof HTMLElement&&(s.dataset.userledHubspotFormId?(s.style.removeProperty("display"),delete s.dataset.userledHubspotFormId):(se.set(t,s.cloneNode(!0)),s.remove()))})},et=(e,t,n)=>(zr(e,t),se.has(t)&&e.insertAdjacentElement("afterend",se.get(t)),jr(e,n,{trigger:!se.has(t)})),Vt=(e,t)=>{switch(t.tagName.toLowerCase()){case"button":Wr(e,t);break;case"input":Gr(e,t);break;case"img":case"div":case"p":case"li":case"span":case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":Jr(e,t);break}},Wr=(e,t)=>{e.addEventListener("click",()=>{w(t,{event:"click"})}),e.addEventListener("blur",()=>{w(t,{event:"blur"})})},Gr=(e,t)=>{e.addEventListener("input",()=>{w(t,{event:"input",value:e.value})}),e.addEventListener("change",()=>{w(t,{event:"change",value:e.value})}),e.addEventListener("focus",()=>{w(t,{event:"focus"})}),e.addEventListener("blur",()=>{w(t,{event:"blur"})})},Jr=(e,t)=>{e.addEventListener("click",()=>{w(t,{event:"click"})}),e.addEventListener("blur",()=>{w(t,{event:"blur"})}),e.addEventListener("focusout",()=>{w(t,{event:"focusout"})})},w=(e,{event:t,...n})=>{var i;if(!(e instanceof Element))throw new Error(`Expected an Element but received ${typeof e} instead!`);const[r,s]=Object.entries(n)[0]??[];if(r){const o=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(e),r);(i=o==null?void 0:o.set)==null||i.call(e,s)}e.dispatchEvent(new Event(t,{bubbles:!0}))};let H=!1,zt=-1,M=-1,W=-1,G=0,ee,A;const Yr=38e3;let jt=!1,te=-1;const Bt=7*1e3,Qr=()=>{zt=new Date().getTime()},Zr=(e,t)=>{Q(!1),ss(),Wt(e,t)},Xr=e=>{Q(!1),Wt(e)},es=e=>{var n;if(A!==void 0&&(clearTimeout(A),A=void 0),H)return;const t=Gt()/1e3;Q(!0),(n=e==null?void 0:e.onPageClosedTrack)==null||n.call(e,t,"PAGE_HIDDEN")},ts=(e,t)=>{let n=0;return(r,s)=>{var o;const i=Gt()/1e3;n=n+1,G=0,W=new Date().getTime(),(o=t==null?void 0:t.onPageActiveForFixedInterval)==null||o.call(t,i,`COUNT_${n}_${e}_${new Date().toISOString()}_hasScrolledOnce=${r}_scheduleAdjustment=${s}`)}};function ns(e,t,n){te=new Date().getTime();let r=0;const s=ts(e,n);function i(){let o=t;new Date().getTime()-te>t-500?(te=new Date().getTime(),s(jt,r),r=0):(o=t-(new Date().getTime()-te),r=o),A=setTimeout(i,o)}A=setTimeout(i,t)}const Wt=(e,t=Bt)=>{A!==void 0&&(clearTimeout(A),A=void 0),W=new Date().getTime(),G=0,ns(Math.random().toPrecision(3),t,e)},rs=()=>{if(H)return;const e=Math.max(zt,M);e<0||new Date().getTime()-e>Yr&&Q(!0)},ss=()=>{ee!==void 0&&(clearInterval(ee),ee=void 0),M=new Date().getTime(),ee=setInterval(rs,500),window.addEventListener("scroll",()=>{jt=!0,Q(!1)})},Gt=()=>{if(H)return G;if(W>M)return new Date().getTime()-W;const e=new Date().getTime()-M;return G+e},Q=e=>{if(e!==H){if(e){const t=Math.max(W,M);G+=new Date().getTime()-t,H=!0;return}H=!1,M=new Date().getTime()}},tt="a",nt="c",rt="ul_e";let pe;const Jt=()=>(pe||(pe=is()),pe),is=()=>{const e=yt(window.location.href);if(!e)return console.error("Invalid URL"),{accountId:void 0,contactId:void 0,email:void 0};const t=e.searchParams,n=t.get(tt)??void 0,r=t.get(nt)??void 0,s=t.get(rt)??void 0,i=n||r||s;return n&&t.delete(tt),r&&t.delete(nt),s&&t.delete(rt),i&&window.history.replaceState({},"",e.toString()),{accountId:n,contactId:r,email:s}};let Yt="",$="";const Ie=()=>$;let Se=[!1,!1],Qt,Zt=v.Website,Xt="",en="";const tn=(e,t)=>{Qt=e,Zt=t.channel,Xt=t.campaignId,en=t.caseId??""},os=()=>({assetId:Qt,channel:Zt,campaignId:Xt,caseId:en}),He=async({name:e,inboundAssetId:t,campaignId:n,caseId:r})=>{const s=yt(window.location.href);if(!s){console.error("Invalid URL");return}Qr(),xn(s.href),a(`page url:${s.href} prev:${document.referrer} name:${e}`,b()),$&&nn(),$=Y(),Se=[!1,!1],await as({inboundAssetId:t,campaignId:n,caseId:r}),Yt=s.href,Zr({onPageActiveForFixedInterval:Me()},parseInt(On)||Bt)};document.addEventListener("visibilitychange",async()=>{document.visibilityState==="hidden"?nn():Xr({onPageActiveForFixedInterval:Me()})});const nn=()=>{es({onPageClosedTrack:Me()})},as=async({inboundAssetId:e,campaignId:t,caseId:n})=>{if(Se[0]){a("Page already sent");return}Se[0]=!0;let r;const s=O();let i=v.Website;s?(i=v.Outbound,r=s):e?(i=v.Inbound,r=e):i=v.Website;const o=Jt();await P("PAGE_LOADED",{campaignId:t,pageId:$,pageName:document.title||window.location.href,url:window.location.href,prevUrl:document.referrer||Yt,assetId:r,channel:i,accountId:o.accountId,contactId:o.contactId,email:o.email,caseId:n})};function Me(){return $?function(e,t){var c,u;const n=Math.round(e);if(n==0)return;const{assetId:r,channel:s,caseId:i,campaignId:o}=os();P("PAGE_CLOSED",{assetId:r,pageId:$,timeActive:n,url:window.location.href,debugMsg:t,channel:s,caseId:i,campaignId:o,customSiteId:(c=Us())==null?void 0:c.id,promptId:(u=Or())==null?void 0:u.id})}:()=>{}}const cs=new RegExp("^[(http(s)?)://(www.)?a-zA-Z0-9@:%._+~#=]{2,256}.[a-z]{2,6}\\b([-a-zA-Z0-9@:%_+.~#?&//=]*)$","i");let ie;const ls=()=>ie!==void 0,ds=e=>{var r;if(!(e!=null&&e.oldValue)||!e.target)return[];const t=e.target,n=(r=e.oldValue)==null?void 0:r.split(";").reduce((s,i)=>{var u;const[o,c]=i.split(":");return o&&(s[o.trim()]=(u=c==null?void 0:c.split("!important")[0])==null?void 0:u.trim()),s},{});return Object.entries(t.style).filter(([s,i])=>(n[s]||void 0)!==(i||void 0))};class rn{constructor(t,n){this.mutationObserver=new MutationObserver(()=>{this.isEditing||ge(this)}),this.styleObserver=new MutationObserver(r=>{if(!this.originalElement||!this.element)return;const s=ds(r[0]),i=this.element.style;s.forEach(([o,c])=>{i.setProperty(o,c??null)})}),this.apply=r=>{if(Ae===void 0&&us(),this.isApplied||r!=null&&r.skipClone)return this.originalElement&&this.prop.type==="contactForm"&&et(this.originalElement,this.id,this.prop),ge(this),this;const s=this.originalElement;if(s===void 0)return this;s.setAttribute(T,this.id);let i;return this.prop.type==="contactForm"?i=et(s,this.id,this.prop):(i=s.cloneNode(!0),this.prop.type==="text"&&C()&&window.userledSettings.enableInlineEditing&&i.setAttribute("contenteditable","true"),Kt(s),s.insertAdjacentElement("afterend",i)),i.setAttribute(x,this.id),this.registerElement(i),ge(this),this.observe(),this.isApplied=!0,E.set(this.id,this),this},this.registerElement=r=>{this.originalElement&&(this.element=r,!C()&&Vt(this.element,this.originalElement))},this.getSelector=()=>this.isApplied?me(this.id):this.prop.propKey,this.getDOMElement=()=>{const r=this.getSelector();return document.querySelector(r)},this.remove=()=>{const r=this.originalElement;if(r===void 0)return console.error("Trying to remove an element with no original ref",this.id),this;const s=this.element;return s===void 0?(console.error("Trying to remove an element which is not on the page",this.id),this):(this.prop.type==="contactForm"?Br(s,this.id):qt(r),s.remove(),r.removeAttribute(T),E.delete(this.id),this)},this.observe=()=>{var r;this.element!==void 0&&((r=this.mutationObserver)==null||r.observe(this.element,{subtree:!0,characterData:!0}),this.originalElement&&this.styleObserver.observe(this.originalElement,{attributes:!0,attributeFilter:["style"],attributeOldValue:!0}))},this.reset=()=>{this.mutationObserver.disconnect(),this.styleObserver.disconnect(),this.originalElement=void 0,this.element=void 0},this.id=t.userledId||Y(),this.prop=t,this.isApplied=!1,this.originalElement=n,this.isEditing=!1,this.prop.userledId=this.id}}const E=new Map;let Ae;const us=()=>{Ae=new MutationObserver(e=>{E.size===0||!e.some(n=>{var r,s;return n.type==="childList"||(((r=n.addedNodes)==null?void 0:r.length)||0)>0||(((s=n.removedNodes)==null?void 0:s.length)||0)>0})||setTimeout(()=>{for(const[,n]of E){let r=n.getDOMElement();n.isApplied&&!r&&(n.isApplied=!1,r=n.getDOMElement()),!n.isApplied&&r&&sn(n.prop)}},25)}),Ae.observe(document,{childList:!0,subtree:!0})},$e=(e,t)=>{if(Rs()){a("Legacy site has applied custom site. Ignoring asset.");return}if(ie&&!t){a(`Ignoring applyAsset: there's already an active asset [${ie.id}].`);return}if(!e.url||!ue(e.url,window.location.href)){console.warn(`Trying to apply asset [${e.id}] on the wrong url.`);return}Ue(),ie=e;const n=Object.values(e.props??{});return De(n),C()||Es(),!0},ms=e=>{var t;return(t=E.get(e))==null?void 0:t.prop},sn=async e=>{if(e.userledId&&E.get(e.userledId)){const i=E.get(e.userledId);if(i)return i.prop=e,i.apply(),e}const t=Ue(),n=[e,...t],r=new Set,s=new Set;return n.forEach(i=>{s.has(i.propKey)||(s.add(i.propKey),r.add(i))}),De([...r]),e},De=e=>{const t=new Set;for(const n of e){const r=document.querySelector(n.propKey)||void 0,s=new rn(n,r);t.add(s)}for(const n of t)n.apply();return e},Ue=()=>{const e=[];for(const[t,n]of E)on(t),e.push(n.prop);return e},on=e=>{var n;const t=E.get(e);if(t!=null&&t.prop.propKey&&((n=document.getElementById(an(t.prop.propKey)))==null||n.remove()),!t){console.error("Trying to remove an element which is not applied.",e);return}return t.remove(),t.prop},ge=async e=>{const t=e.element,n=e.originalElement;if(!t||!n){console.error("Trying to apply edit with no element or original",t,n);return}switch(e.prop.type){case"text":return C()&&(t.addEventListener("focus",()=>{e.isEditing=!0}),t.addEventListener("blur",()=>{e.isEditing=!1}),t.addEventListener("focusout",()=>{e.isEditing=!1})),e.isEditing?void 0:hs(e.prop,t,n);case"image":return fs(e.prop,t,n);case"button":return gs(e.prop,t,n);case"input":return ws(e.prop,t,n);case"iframe":return ps(e.prop,t,n);case"svg":return ys(e.prop,t,n);case"contactForm":return;default:console.error("unknown edit type",e.prop.type);return}},hs=async(e,t,n)=>{if(!_(t)||!_(n)){console.error("trying to apply text edit to non-text element",e.propKey);return}const r=I(e.value);r!==null&&(t.innerHTML=r,D(t,n,e.customStyle))},ps=async(e,t,n)=>{if(!R(t)||!R(n)){console.error("trying to apply iframe edit to non-iframe element",e.propKey);return}const r=e.src?I(e.src):null,s=r?!!r.match(cs):!1;if(!e.srcdoc&&!s){console.error("invalid iframe source:",e.propKey,r);return}r&&s?t.src=r:e.srcdoc&&(t.srcdoc=e.srcdoc),D(t,n,e.customStyle)},gs=async(e,t,n)=>{if(!F(t)||!F(n)){console.error("trying to apply button edit to non-button element",e.propKey);return}if(e.value!==void 0){const r=I(e.value);if(r===null)return;t.innerHTML=r}t.href=e.href,D(t,n,e.customStyle),e.trackClicks&&e.trackingName&&t.addEventListener("click",()=>{P("BUTTON_CLICKED",{pageId:Ie(),id:e.propKey,name:e.trackingName,assetId:O(),isConversion:e.isConversion||!1,channel:v.Outbound,value:e.value})});for(const r of e.children??[]){const s=r.propKey.substring(e.propKey.length),i=n.querySelector(s);if(!i){console.error("could not find button original child element",r);return}const o=t.querySelector(s);if(!o){console.error("could not find button child element",r);return}const c=new rn(r,i);c.registerElement(o),c.apply({skipClone:!0})}},fs=async(e,t,n)=>{if(!k(t)||!k(n)){console.error("trying to apply image edit to non-image element",e.propKey);return}let r=e.src;if(e.imageType==="smart"&&C()){const{src:i,needApplying:o}=vs(e,t);if(!o)return;r=i}if(r){if(st(t,r),t.parentElement&&$t(t.parentElement))for(let i=0;i<t.parentElement.children.length;i++){const o=t.parentElement.children[i];o&&Dt(o)&&st(o,r)}D(t,n,e.customStyle)}},ys=async(e,t,n)=>{if(!N(t)||!N(n)){console.error("trying to apply svg edit to non-svg element",e.propKey);return}const r=e.value;if(!r)return;const s=new DOMParser().parseFromString(r,"text/html").body.firstChild;[...s.attributes].forEach(({name:i,value:o})=>{i!==x&&i!==T&&t.setAttribute(i,o)}),t.innerHTML=s.innerHTML,D(t,n,e.customStyle)},st=(e,t)=>{const n=e.getAttribute("srcset");e.srcset=t,e.src="",n!=null&&n.startsWith("blob:")&&URL.revokeObjectURL(n)},an=e=>`userled-loader-${e}`,vs=(e,t)=>{var s,i,o,c,u,p;const n=an(e.propKey);if(!e.props)return(s=document.getElementById(n))==null||s.remove(),t.alt="Please select a smart image",{src:"https://assets.userled.io/media/gradient.png",needApplying:!0};if(e.customSitePreviewBlob)return(i=document.getElementById(n))==null||i.remove(),t.style.display=((o=e.customStyle)==null?void 0:o.display)??"",{src:URL.createObjectURL(e.customSitePreviewBlob),needApplying:!0};if(document.getElementById(n))return{src:"",needApplying:!1};t.style.display="none";const r=bs(n,((c=e.customStyle)==null?void 0:c.width)??"100%",((u=e.customStyle)==null?void 0:u.height)??"100%");return(p=t.parentElement)==null||p.insertBefore(r,t),{src:"",needApplying:!1}},ws=async(e,t,n)=>{if(!U(t)||!U(n)){console.error("trying to apply input edit to non-input element",e.propKey);return}if(e.placeholder===void 0&&e.value===void 0)return;const r=I(e.value??""),s=I(e.placeholder??"");t.value=r??"",t.placeholder=s??"",t.dispatchEvent(new Event("change")),t.dispatchEvent(new Event("input")),D(t,n,e.customStyle)},D=(e,t,n)=>{if(n){e.style.cssText=t.dataset.originalStyle||"";for(const[r,s]of Object.entries(n)){const i=r.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1-$2").toLowerCase();e.style.setProperty(i,s)}}},bs=(e,t,n)=>{const r=document.createElement("div");r.id=e,r.style.display="inline-block",r.style.width=t,r.style.height=n;const s=document.createElement("div");s.style.width="100%",s.style.height="100%",s.style.background="linear-gradient(-45deg, #ffe56f 0%, #FFC4F6 100%)",s.style.backgroundSize="300%",s.style.backgroundPosition="center",s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center";const i=document.createElement("div");return i.classList.add("userled-smart-image-loader"),i.setAttribute(j,"true"),s.appendChild(i),r.appendChild(s),r},Es=()=>{const e=new URLSearchParams(window.location.search);if(e.delete(pn),!e.toString())return;document.querySelectorAll("a").forEach(n=>{try{const r=new URL(n.href);for(const[s,i]of e.entries())r.searchParams.set(s,i);n.href=r.toString()}catch{}})},Is=e=>e.match(/{{.*?}}/g),Ss=e=>{const t=e.match(/{{ *query.([a-zA-Z_]+) *( || +([a-z]+) *){0,1}}}/);if(!t||t.length<2)return["",void 0];const[n,r]=[t[1],t[3]];return n?r?[n,Ps[r]]:[n,cn]:["",void 0]};function As(e){const t=/[a-z]/;return e.replace(t,Re)}function Cs(e){const t=/[a-z]/g;return e.replace(t,Re)}function Re(e){return e.toUpperCase()}function Ts(e){return e.toLowerCase()}const cn=e=>e,Ps={"":cn,title:Cs,capitalised:As,upper:Re,lower:Ts},Z=(e,t,n)=>{var r;if(!e)return{};if(!t)return e;if(n!=null&&n.matchedCase){const s=(r=e.caseOverwrites)==null?void 0:r[n.matchedCase.id];e={...e,...s},delete e.caseOverwrites}switch(e.type){case"text":return Os(e,t,n);case"button":return Ls(e,t,n);case"logo":return _s(e,t);case"image":return ks(e,t,n);case"input":return Fs(e,t,n);case"container":return xs(e,t,n);case"video":return Hs(e,t,n);case"iframe":return Ms(e,t,n);case"calendar":return $s(e,t,n);case"background":case"contactForm":case"placeholder":case"svg":return e}},xs=(e,t,n)=>{const r=e.children.map(s=>Z(s,t,n));return{...e,children:r}},Os=(e,t,n)=>({...e,value:g(e.value,t,n)}),Ls=(e,t,n)=>{var i;const r=(i=e.children)==null?void 0:i.map(o=>Z(o,t,n)),s=e.contentHubMetadata?{...e.contentHubMetadata,header:{imageUrl:g(e.contentHubMetadata.header.imageUrl,t,n),title:g(e.contentHubMetadata.header.title,t,n)}}:void 0;return{...e,value:e.value?g(e.value,t,n):e.value,href:g(e.href,t,n),contentHubMetadata:s,children:r}},_s=(e,t)=>{const n=vt(e.url);if(n.length===0)return e;const r=t.getValue(n[0]);return typeof r!="string"?e:{...e,url:r}},ks=(e,t,n)=>{if(e.imageType==="variable"&&e.src)return{...e,src:g(e.src,t,n)};if(e.imageType==="smart")return{...e,props:e.props?Object.fromEntries(Object.entries(e.props).map(([s,i])=>[s,Z(i,t,n)])):void 0};if(e.useTargetLogo!==void 0&&!e.useTargetLogo||e.imageType&&e.imageType!=="target_logo")return e;let r=t.getValue(Ln);return typeof r!="string"?e:{...e,src:r}},Fs=(e,t,n)=>!e.placeholder&&!e.value?e:{...e,value:e.value?g(e.value,t,n):e.value,placeholder:e.placeholder?g(e.placeholder,t,n):e.placeholder},Hs=(e,t,n)=>({...e,src:e.src?g(e.src,t,n):e.src}),Ms=(e,t,n)=>({...e,src:e.src?g(e.src,t,n):e.src,srcdoc:e.srcdoc?g(e.srcdoc,t,n):e.srcdoc}),$s=(e,t,n)=>({...e,url:g(e.url,t,n)}),g=(e,t,n)=>vt(e).reduce((s,i)=>{const o=t.getValue(i);return typeof o=="string"?!o&&(n!=null&&n.keepUnresolved)?s:s.replace(i.raw,o):s},e),Ds=(e,t)=>{const n=Object.entries(e.props??{}).reduce((r,[s,i])=>(r[s]=Z(i,t),r),{});return{...e,props:n}},ln=(e,t,n)=>{if(!e.dynamic||!e.cases)return e;try{const r=Object.entries(e.props??{}).reduce((s,[i,o])=>(s[i]=Z(o,t,{matchedCase:n}),s),{});return{...e,props:r}}catch(r){return console.error(`Could not resolve dynamic asset [${e.id}]: ${r}`),e}},fe="<!-- userled:custom-code-start -->",ne="<!-- userled:custom-code-end -->",dn=new Map;let f;const Us=()=>f,Rs=()=>!!(f!=null&&f.id);class Ns{constructor(t,n){const r=t.id||Y();this.id=r,this.edit=t,this.edit.id=r,this.originalElement=n,this.isApplied=!1}registerElement(t){var n,r;this.originalElement&&(this.element=t,Vt(this.element,this.originalElement),this.edit.original=this.originalElement?new B(this.originalElement).value():void 0,this.edit.computedCSS=new B(t).getStyle(),this.mutationObserver=new MutationObserver(()=>{Ce(this)}),this.intersectionObserver=new IntersectionObserver(s=>{s.some(i=>i.isIntersecting===!1)&&!document.querySelector(me(this.edit.id??""))&&(this.reset(),qe(this))},{root:document.querySelector("body")}),(n=this.mutationObserver)==null||n.observe(t,{subtree:!0,characterData:!0}),(r=this.intersectionObserver)==null||r.observe(t))}disconnect(){var t,n;(t=this.mutationObserver)==null||t.disconnect(),(n=this.intersectionObserver)==null||n.disconnect()}reset(){this.disconnect(),this.originalElement=void 0}}const h=new Map,un=()=>{const e=[];for(const[t,n]of h)q(t),e.push(n.edit);return e},K=new MutationObserver(e=>{if(e.some(n=>{var r;return n.type==="childList"&&((r=n.addedNodes)==null?void 0:r.length)>0})){for(const[,r]of h)r.originalElement||Ne(r.edit);[...h.values()].every(r=>!!r.originalElement)&&K.disconnect()}});function Ks(e){dn.set(e.id,e);const t=de();if(ls()){a("Ignoring applyCustomSite: asset already apply.");return}if(f!=null&&f.id){a("Site already applied",f.id,"Trying to apply site",e.id);return}hn(e,t)}const q=e=>{const t=h.get(e),n=t==null?void 0:t.originalElement;if(!t||!n)return;t.disconnect();const r=document.querySelector(me(e)),s=document.querySelector(Vr(e));return!r||!s?void 0:(r.remove(),qt(s),s.removeAttribute(T),h.delete(e),new B(n).value())},qs=e=>{const t=h.get(e);if(!t){console.warn("Page edit not found");return}return t.edit},I=e=>{if(C())return e;const t=Is(e);if(!t)return e;let n=e;const r=new URLSearchParams(window.location.search);for(const s of t){const[i,o]=Ss(s);if(!i||!o)return null;const c=_n(r.get(i));if(!c)return null;n=n.replace(s,o(c))}return n},ye=(e,t,n)=>{const r=n.appliedCSS;if(r){e.style.cssText=t.dataset.originalStyle||"";for(const[s,i]of Object.entries(r))e.style.setProperty(s,i)}},Ce=e=>{const t=e.element,n=e.originalElement,r=e.edit;if(!n||!t)return!1;if(_(t)&&$r(r)){const s=I(r.value.value);if(s===null)return q(t.id),!1;t.innerHTML=s,ye(t,n,r)}else if(F(t)&&Ur(r)){const s=I(r.value.value);if(s===null)return q(t.id),!1;t.innerHTML=s,t.href=r.value.href,ye(t,n,r)}else if(k(t)&&Dr(r))js(t,r),ye(t,n,r);else if(Qe(r)&&Ut(t))zs(r);else if(Qe(r)&&Rt(t))Vs(r);else throw q(t.id),`unrecognised html tag [${r.tag}]`;return!0},Vs=e=>{const t=I(e.value.value);if(!t)return;const n=document.querySelector(me(e.id??""));n&&n.remove();const r=document.createElement("script");r.textContent=t,r.setAttribute(x,e.id??""),document.body.appendChild(r)},zs=e=>{const t=I(e.value.value),n=document.querySelector(e.tag);if(!n||!t)return;const r=n.innerHTML,s=r.indexOf(fe),i=r.indexOf(ne);let o;s>-1&&i>-1?o=r.substring(0,s)+fe+t+ne+r.substring(i+ne.length):o=r+fe+t+ne,document.head.innerHTML=o},js=(e,t)=>{if(e.srcset=t.value.url,e.src="",e.parentElement&&$t(e.parentElement))for(let n=0;n<e.parentElement.children.length;n++){const r=e.parentElement.children[n];r&&Dt(r)&&(r.srcset=t.value.url,r.src="")}},Ne=e=>{if(e.id&&h.get(e.id)){const i=h.get(e.id);if(i)return i.edit=e,qe(i),e}const t=un(),n=[e,...t],r=new Set,s=new Set;return n.forEach(i=>{s.has(i.selector)||(s.add(i.selector),r.add(i))}),Ke([...r]),e},Ke=e=>{const t=new Set;for(const n of e){const r=n.selector,s=document.querySelector(r)||void 0,i=new Ns(n,s);t.add(i)}for(const n of t)qe(n);return e},qe=e=>{if(!e.originalElement)return h.set(e.id,e),K.observe(document,{childList:!0,subtree:!0}),!0;if(e.isApplied)return Ce(e);const t=e.edit,n=e.originalElement,r=n.cloneNode(!0);return n.setAttribute(T,e.id),Kt(n),n.insertAdjacentElement("afterend",r),r.setAttribute(x,e.id),e.registerElement(r),Ce(e)?(e.isApplied=!0,h.set(e.id,e),!0):(console.error("Failed to apply personalisation. Could not apply edit",t),!1)},mn=()=>{for(const[,e]of h)e==null||e.disconnect();K==null||K.disconnect()};window.onpagehide=()=>{mn()};function Bs(e,t,n){a(`Sending CustomSiteRendered: [customSiteId:${e}, url:${t}]`),P("CUSTOM_SITE_RENDERED",{customSiteId:e,url:t,targetId:n,appliedEdits:h.size})}const Ws=()=>{const e=de();if(C()){for(const n of h.values())n.reset(),Ne(n.edit);return}mn(),h.clear();let t=!1;for(const[,n]of dn)if(t=hn(n,e),t)break;t||(f=void 0)},hn=(e,t,n)=>{for(const r of e.pages)if(ue(r.url,t))return f={id:e.id,pageUrl:r.url},a("Applying custom site",f.id,r.url,e,b()),Ke(r.edits),Bs(f.id,t,n),!0;return!1};async function Gs(e){if(!e)return;const t=await oe.getAsset(e),n=t.cases||[],r=document.createElement("iframe");r.style.cssText="position:fixed;bottom:2.5rem;height:64px;z-index:1000;left:50%;transform:translateX(-50%);overflow:hidden;border:none;width:calc(100% - 5rem);max-width:834px;",r.setAttribute("scrolling","no"),r.setAttribute("allow","clipboard-write");const s=window.matchMedia("(max-width: 480px)").matches,i=n.length>0,o=n.map(p=>{const L=document.createElement("option");return L.value=p.id,L.innerText=p.name,L}),c=i?`      <div style="display:flex;align-items:center;gap:16px;border-left:1px solid #fff;border-right:1px solid #fff;padding-inline:16px;flex:1;">        <div style="font-size:14px;font-weight:600;">Preview variant</div>        <select id="variant-select" style="height:32px;min-width:130px;border-radius:.5rem;border-width:1px;border-color:#0000;padding-left:.5rem;padding-right:.5rem;padding-top:.25rem;padding-bottom:.25rem;font-size:.875rem;line-height:1.25rem;font-weight:600;background:white;color:black;font-family:inherit;">          <option value="">Default</option>          ${o.map(p=>p.outerHTML).join("")}        </select>      </div>`:s?"":`      <div style="display:flex;flex-direction:column;align-items:center;text-align:center;">        <div style="font-size:12px;font-weight:600;">This is a preview for a Userled website.</div>        <div style="font-size:12px;font-weight:500;">Internal use only.</div>      </div>    `,u=`    <html>      <head>        <style>          @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,100..1000&display=swap');        </style>      </head>      <body style="margin:0;padding:0;font-family:'DM Sans',sans-serif;display:flex;justify-content:center">        <div style="width:fit-content;padding-right:1.25rem;padding-top:1rem;padding-bottom:1rem;padding-left:1.5rem;background-repeat:no-repeat;background-position:0 100%;background-size:auto;background-image:url(${Be}/brush.png);background-color:#FFC4F6;border-radius:9999px;display:flex;align-items:center;gap:16px;justify-content:space-between;">          <img src="${Be}/userled_logo.svg" style="height:16px;" />          ${c}          <button id="share-button" style="cursor:pointer;display:inline-flex;height:32px;min-width:130px;align-items:center;justify-content:center;white-space:nowrap;border-radius:.5rem;border-width:1px;border-color:#0000;padding-left:1rem;padding-right:1rem;padding-top:.25rem;padding-bottom:.25rem;font-size:.875rem;line-height:1.25rem;font-weight:600;background:black;color:white;font-family:inherit;">            Share preview          </button>          <script>            document.addEventListener("DOMContentLoaded", () => {              document.getElementById("share-button").addEventListener("click", (e) => {                navigator.clipboard.writeText('${kn.Preview}/${e}');                e.target.innerText = "Link copied!";              });              document.getElementById("variant-select")?.addEventListener("change", (e) => {                const caseId = e.target.value;                window.parent.postMessage({ type: "apply-case", caseId }, "*");              });            });          </script>        </div>      </body>    </html>  `;r.setAttribute("srcdoc",u),document.body.appendChild(r),window.addEventListener("message",p=>{if(p.data.type==="apply-case"){const L=p.data.caseId,Ve=n.find(he=>he.id===L),yn=Ve?ln(t,{getValue:he=>he.raw},Ve):t;$e(yn,!0)}})}const pn="userled_asset",O=()=>Fn(window.location.search,pn),Js=async()=>{var n;const e=O(),t=le();if(e)try{const[r,s]=await Promise.all([oe.getAsset(e),window.userledSettings.enableDynamicAssets&&t?oe.matchAssetCase(e,t,window.location.href):Promise.resolve(null)]),i=(n=r.cases)==null?void 0:n.find(c=>c.id===(s==null?void 0:s.caseId)),o=r.dynamic&&s&&i?ln(r,{getValue:c=>{if(!(c.raw in s.variables))throw new Error("Variable not found in match result");return s.variables[c.raw]}},i):r;$e(o),tn(r.id,{channel:v.Outbound,campaignId:r.campaignId,caseId:i==null?void 0:i.id}),await He({name:document.title||window.location.href,campaignId:r.campaignId,caseId:i==null?void 0:i.id})}catch(r){console.error(`Could not render site asset [${e}]: ${r}`)}else Er(),Ws()},Ys=function(){let e="";return function(){const t=ft();t&&e!=t&&(e=t,P("HUTK_DETECTED",{hutk:e}))}}();let it;const Qs=()=>{it||(it=window.setInterval(Ys,2e3))},ot=async e=>{try{const t=await fetch(Hn.Inbound(e));if(!t.ok)throw new Error("Failed to fetch inbound campaigns from cloudfront");const n=await t.json();return Xn(n),n}catch(t){throw new Error(`Failed to fetch inbound campaigns: ${t}`)}},Zs=async e=>{const t=er();return t?(ot(e),t):ot(e)},Xs=async()=>{const e=y(),t=le();if(!e||!t)return!1;const n=Mn(`Fetching and matching inbound campaigns of [${e}]`),[r,s]=await Promise.all([nr({orgId:e,userId:t,serverUrl:J,url:window.location.href}),Zs(e)]);if(n(),!r)return a("Inbound campaign not matched, skipping"),!1;if(!s||s.length===0)return a("No inbound campaigns, skipping"),!1;const i=s.find(u=>u.id===r.inboundCampaignId);if(!i)return a("No inbound campaign found, skipping"),!1;const o=i.inboundAssets.find(u=>u.status!=="active"?!1:ue(u.url,window.location.href));if(!o)return a("No inbound asset found for the current URL",window.location.href),!1;const c=Ds(o,r);return $e(c),tn(o.id,{channel:v.Inbound,campaignId:i.id}),await He({name:document.title||window.location.href,inboundAssetId:o.id,campaignId:i.id}),n(),!0},at={ShowPrompt:"SHOW_PROMPT",ShowCustomSite:"SHOW_CUSTOM_SITE"};function ei(e){const t=JSON.parse(e.data),n=O();switch(t.type){case at.ShowPrompt:if(n)return;br(t.body);break;case at.ShowCustomSite:if(n)return;a("Received custom site message",t.body.id),Ks(t.body);break;default:a(`Unrecognised event type: ${t.type}`);return}}const ti=async({overrideFingerprintEnabled:e}={})=>{const{app_id:t,enableIdentification:n}=Pe();if(!t){a("no userled appId set");return}const r=await $n({fingerprintEnabled:e||n&&!ce()});if(!(r!=null&&r.userFingerprint)){a("No fingerprint generated");return}return{userFingerprint:r.userFingerprint||void 0,requestId:r.requestId||void 0}};let re,ct;const ni=async e=>(ct=async()=>{const{app_id:t}=Pe();if(!t){a("no userled appId set");return}a("Opening websocket",b());const n=await ti(),r=n==null?void 0:n.userFingerprint,s=n==null?void 0:n.requestId;return new Promise(i=>{re=new WebSocket(ii(t,r,s)),re.onopen=()=>{a("Connection opened",b(),Dn()),i()},re.onclose=ri,re.onmessage=o=>si(o,e)})},ct()),ri=e=>{a(`Connection closed (code:${e.code}) (reason:${e.reason}) (wasClean:${e.wasClean})`)},si=(e,t)=>{t(e)};function ii(e,t,n){const r=new URL(Un);r.searchParams.set("app_id",e),r.searchParams.set("browser_id",oi());const s=le();s&&r.searchParams.set("user_id",s),t&&r.searchParams.set("fingerprint",t),n&&r.searchParams.set("request_id",n);const i=Ot();i&&r.searchParams.set("session_id",i);const o=wt();if(o&&r.searchParams.set("snippet_version",o),Vn())return r;const c=Nn();c&&r.searchParams.set("snippet_executed_at",c.toString());const u=Kn;u&&r.searchParams.set("sdk_executed_at",u.toString());const p=qn();return p&&r.searchParams.set("first_visible_at",p.toString()),r.searchParams.set("dom_loaded",(document.readyState!=="loading").toString()),r.searchParams.set("ws_init_at",Rn().toString()),r}const lt="userled_browser_id";let ve=null;const oi=()=>{if(ve)return ve;let e=mt(lt);return e||(e=Y(),ve=e,ht(lt,e)),e},ai=async()=>Js(),Te=async e=>{try{await fetch(`${J}/api/debug`,{method:"POST",body:JSON.stringify({...e,url:window.location.href,version:gt()}),keepalive:!0})}catch(t){console.error("Failed to send debug log",t)}},ci=async e=>{var t;try{await fetch(`${J}/api/metrics`,{method:"POST",body:JSON.stringify(e),keepalive:!0})}catch(n){let r;n instanceof Error&&(r=n.stack),Te({message:"Failed to send metrics",error:String(n),stack:r,name:(t=e[0])==null?void 0:t.name})}},gn=()=>{const e=performance.now();return t=>{const r=(performance.now()-e)/1e3;ci([{name:"userled_sdk_latency_seconds",value:r,labels:t}])}},li=async()=>{const e=O()??void 0,t=zn()||!!e&&!jn,n=Jt();return Bn(y(),{apiUrl:`${J}/api`,snippetVersion:wt(),useFingerprint:t,assetId:e,accountId:n.accountId,contactId:n.contactId,email:n.email})};(async()=>{if(ce()){a(`Running SDK in DRY mode. Editor: ${C()}, Screenshot: ${Wn()}, Preview: ${bt()}`),ut();return}try{const e=gn();(await li()).cached||e({org_id:y(),metric:"setup_sdk"}),Gn()&&await ni(ei),ut()}catch(e){if(e instanceof Jn){Te({message:"Failed to identify user",errorType:e.type,orgId:y(),pageId:Ie(),error:e.message,stack:e.stack,userAgent:navigator.userAgent,duration:b()});return}Te({message:"Failed to identify user",errorType:"unknown_error",orgId:y(),pageId:Ie(),error:String(e),stack:e.stack,userAgent:navigator.userAgent,duration:b()})}})();function dt(){const e=Et();for(a(`Flushing ${e.queue.length} items from queue`,b());e.queue.length>0;){const t=e.queue.shift();if(!t)continue;const[n,,r,...s]=t,i=fn(r,s);n(i)}}window.onresize=_t;window.addEventListener("load",()=>{ce()||setTimeout(()=>oe.reportLatency(y()),1e3)});async function di(){const e=O(),t=gn();if(e){await ai(),t({org_id:y(),metric:"outbound"});return}if(Yn){let n=!1;try{n=await Xs(),t({org_id:y(),metric:"inbound"})}catch(r){a("Error matching inbound campaign",r)}finally{n||await He({name:document.title||window.location.href})}}}async function fn(e,t){switch(e){case"page":return xe.enqueue(()=>di());case"getPageEdit":return qs(t[0]);case"applyEdit":return Ne(t[0]);case"applyEdits":return Ke(t[0]);case"removeEdit":return q(t[0]);case"removeEdits":return un();case"getAssetProp":return ms(t[0]);case"applyAssetProp":return sn(t[0]);case"applyAssetProps":return De(t[0]);case"removeAssetProp":return on(t[0]);case"removeAssetProps":return Ue();default:return console.error("command undefined: ",e),Promise.resolve()}}function ut(){a("Setting up SDK",b());const e=Et();dt(),e.call=async t=>{const[n,...r]=t;return await fn(n,r)},dt(),bt()&&Gs(O()),Qs(),a("Set up SDK",b())}